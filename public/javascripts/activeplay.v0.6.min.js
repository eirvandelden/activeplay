var ApStore={token:"",lastTimestamp:"",users:[],messages:[],user:{name:"",color:"",residentId:"",characterId:"",campaignId:""},inputText:"",initiative:{timestamp:0,turn:0,round:0,entities:[]}},ApChatInput=Vue.extend({template:'<input type="text" v-model="inputText" id="ap-inputText" autocomplete="off" autocorrect="off" autocapitalize="off" maxlength="500" style="margin-bottom: 0px;" placeholder="Type here..." v-on:keyup.13="processMessage">',data:function(){return{REGEX_NAME:/(^"(?:\\?.)*?")|(^\w*)/i,REGEX_WHISPER:/(^\/w )|(^\/pm )|(^\/whisper )/i,REGEX_ROLL:/(^\/r )|(^\/roll )/i,REGEX_GMROLL:/(^\/gmr )|(^\/gmroll )/i,REGEX_HELP:/(^\/help)|(^\/\?)/i,helpText:['/r <span style="color: #4e74a5">or</span> /roll <span style="color: #4e74a5">ndx+b</span>','/r <span style="color: #4e74a5">or</span> /roll <span style="color: #4e74a5">name ndn+b</span>','/r <span style="color: #4e74a5">or</span> /roll "<span style="color: #4e74a5">name with space(s)</span>" <span style="color: #4e74a5">ndn+b</span>','/gmr <span style="color: #4e74a5">or</span> /gmroll send dice roll to GM','/w <span style="color: #4e74a5">or</span> /pm <span style="color: #4e74a5">or</span> /whisper "<span style="color: #4e74a5">recipient</span>" <span style="color: #4e74a5">message</span>','/help <span style="color: #4e74a5">or</span> /?']}},props:["inputText"],methods:{processMessage:function(){if(this.inputText){var e=this.inputText.toString(),t={text:e=$("<div/>").html(e).text(),timestamp:new Date};this.REGEX_WHISPER.test(this.inputText)?(t.text=this.inputText.replace(this.REGEX_WHISPER,""),t.recipient=this.getRecipient(t.text),t.recipientId=this.getRecipientId(t.recipient),t.recipientId?(t.text=t.text.replace(t.recipient,"").replace('""',"").trim(),this.$dispatch("evt-sendMessage",t)):(t.text=t.recipient+" is not online.",t.recipient=null,t.type="system",this.$dispatch("evt-addMessage",t))):this.REGEX_ROLL.test(this.inputText)?(t.text=this.inputText.replace(this.REGEX_ROLL,""),this.$dispatch("evt-sendDice",t)):this.REGEX_GMROLL.test(this.inputText)?(t.text=this.inputText.replace(this.REGEX_GMROLL,""),t.recipient="GM",t.recipientId=this.getRecipientId("GM"),t.recipientId?this.$dispatch("evt-sendDice",t):(t.text=t.recipient+" is not online.",t.recipient=null,t.type="system",this.$dispatch("evt-addMessage",t))):this.REGEX_HELP.test(this.inputText)?(t.text=null,t.html="<strong>Commands</strong><ul><li>"+this.helpText.join("</li><li>")+"</li></ul>",this.$dispatch("evt-addMessage",t)):this.$dispatch("evt-sendMessage",t),this.inputText=""}},getRecipient:function(e){return e.match(this.REGEX_NAME)[0].replace(/["]/g,"")},getRecipientId:function(e){var t,i=this.$parent.users;for(u in i)i[u].name.toLowerCase()===e.toLowerCase()&&(t=i[u].residentId);return t||null}}});Vue.component("ap-chat-input",ApChatInput);var ApChatMessages=Vue.extend({template:'<ul class="no-bullet"><li v-for="message in messages"><div style="word-wrap: break-word;"><span v-show="message.timestamp" class="ap-timestamp" data-timestamp="{{ message.timestamp }}"> {{ timestamp_formated(message.timestamp) }} </span><strong v-show="message.sender" style="color: {{ message.usercolor }};">{{ message.sender }}</strong><strong v-show="message.recipient" style="color: #c5c5c5;"> <i class="fa fa-chevron-right"></i>  {{ message.recipient }} <a v-show="message.showReply" v-on:click="privateMessage(message.sender)"><i class="fa fa-reply"></i></a></strong> </div><div class="ap-msg"><div v-show="message.text" v-bind:class="message.cssClass">{{ message.text }}</div><div v-show="message.html" v-bind:class="message.cssClass">{{{ message.html }}}</div></div></li></ul>',props:["messages"],methods:{timestamp_formated:function(e){return new moment(new Date(e)).calendar(null,{sameElse:"MMM Do YYYY"})},privateMessage:function(e){this.$dispatch("evt-privateMessage",e)},timestamp:function(e){return new Date(e).toLocaleTimeString()}}});Vue.component("ap-chat-messages",ApChatMessages);var ApDiceBag=Vue.extend({template:'<div class="text-right" style="margin-bottom: .75em; line-height: .5em;"><a v-for="dice in die" v-on:click="sendDice(dice)"><span class="secondary square label ap-dice" style="margin-left: .25em; margin-top: .25em; font-weight: bold;">{{ dice }}</span></a></ul>',data:function(){return{die:["d4","d6","d8","d10","d12","d20","d100","FATE"]}},methods:{sendDice:function(e){e="FATE"===e?"FATE":"1"+e,this.$dispatch("evt-sendDice",{text:e})}}});Vue.component("ap-dice-bag",ApDiceBag);var ApInitiativeBadgeGm=Vue.extend({template:'<div id="initiative-badge-{{ entity.id }}" class="eb-v1-badge eb-v1-badge-{{ entity.type }} initiative"><div class="row"><div class="small-1 columns"><span style="margin-top: .6em; float: left; color: #c5c5c5"><a class="iconlink add" v-bind:class="{ \'added\': parseInt(index) === parseInt(turn) }" v-on:click="setTurn(index)"><i class="fa fa-chevron-right" style="font-size: 1.5em;"></i></a></span></div><div class="small-8 columns"><div class="eb-v1-badge-over eb-v1-badge-reduced clipper"><span class="eb-v1-badge-name">{{ entity.name }}</span></div><div class="eb-v1-badge-under clipper">{{ entity.residentName }}</div></div><div class="small-2 columns"><div class="eb-v1-badge-over eb-v1-badge-reduced clipper"><input type="text" max="99" v-model="initiative" v-on:blur="onBlur" v-on:keypress="onKeyPress" class="eb-v1-card-input" style="margin-bottom: -1px !important; font-weight: bold;"></div><div class="eb-v1-badge-under clipper text-center"><i class="fa fa-clock-o"></i> Init</div></div><div class="small-1 columns"><span style="margin-top: .6em; float: right;"><a v-on:click="removeEntity(entity)" style="width: 2em; display:inline-block; text-align: right;" class="iconlink delete"><i class="fa fa-times-circle" style="font-size: 1.5em;"></i></a></span></div></div></div>',props:["index","entity","turn"],data:function(){return{initiative:0}},ready:function(){this.initiative=this.entity.initiative},methods:{onKeyPress:function(e){13===e.keyCode&&this.onBlur(),this.initiative.length>1&&(this.initiative=this.initiative.slice(0,1))},onBlur:function(){this.initiative=parseInt(this.initiative,10),this.initiative||(this.initiative=0),this.entity.initiative=parseInt(this.initiative,10),this.$dispatch("evt-sendEntities")},setTurn:function(e){this.$dispatch("evt-setTurn",e)},removeEntity:function(e){this.$dispatch("evt-removeEntity",e)}},events:{"evt-resetInitiative":function(e){this.initiative=0}}});Vue.component("ap-initiative-badge-gm",ApInitiativeBadgeGm);var ApInitiativeBadgePlayer=Vue.extend({template:'<div id="initiative-badge-{{ entity.id }}" class="eb-v1-badge eb-v1-badge-{{ entity.type }} initiative"><div class="row"><div class="small-10 columns"><div class="clipper"><strong>{{ entity.name }}</strong></div></div><div class="small-1 columns text-right"><strong>{{ entity.initiative }}</strong></div><div class="small-1 columns"><span v-if="parseInt(index) === parseInt(turn)"  class="iconlink added"><i class="fa fa-check" style="position: absolute; left: .25em; font-size: 1.6em;"></i></span></div></div></div>',props:["index","entity","turn"]});Vue.component("ap-initiative-badge-player",ApInitiativeBadgePlayer);var ApInitiativeGm=Vue.extend({template:'<div class="row"><div class="small-5 columns"><a class="iconlink" v-on:click="updateTurn(-1)"><i class="fa fa-fw fa-minus-circle delete" style="font-size: 1.25em;"></i></a><strong><span style="color: #c5c5c5;">Trn</span> {{ initiative.turn+1 }}</strong> <a class="iconlink add" v-on:click="updateTurn(1)"><i class="fa fa-fw fa-plus-circle" style="font-size: 1.25em;"></i></a></div><div class="small-2 columns text-center"><a class="iconlink" v-on:click="resetInitiative"><i class="fa fa-fw fa-history" title="Reset Initiative" style="font-size: 1.25em;"></i></a></div><div class="small-5 columns text-right"><a class="iconlink" v-on:click="updateRound(-1)"><i class="fa fa-fw fa-minus-circle delete" style="font-size: 1.25em;"></i></a><strong><span style="color: #c5c5c5;">Rnd</span> {{ initiative.round+1 }}</strong><a class="iconlink add" v-on:click="updateRound(1)"><i class="fa fa-fw fa-plus-circle" style="font-size: 1.25em;"></i></a></div></div><ul class="no-bullet"><li v-for="(index, entity) in initiative.entities | orderBy \'initiative\' -1"><ap-initiative-badge-gm v-bind:entity="entity" v-bind:index="index" v-bind:turn="initiative.turn"></ap-initiative-badge-gm></li></ul>',components:{"ap-initiative-badge-gm":ApInitiativeBadgeGm},props:["initiative"],methods:{resetInitiative:function(e){this.initiative.turn=0,this.initiative.round=0;for(entity in this.initiative.entities)this.initiative.entities[entity].initiative=0;this.sendTurn(),this.$broadcast("evt-resetInitiative"),this.$dispatch("evt-sendEntities")},cycleTurn:function(){this.initiative.turn>this.initiative.entities.length-1&&(this.initiative.turn=0,this.initiative.round++),this.initiative.turn<0&&(this.initiative.round>1?this.initiative.turn=this.initiative.entities.length-1:this.initiative.turn=0,this.initiative.round>0&&this.initiative.round--),this.sendTurn()},updateTurn:function(e){this.initiative.turn=this.initiative.turn+e,this.cycleTurn()},setTurn:function(e){this.initiative.turn=e,this.cycleTurn()},updateRound:function(e){this.initiative.round=this.initiative.round+e,this.initiative.turn=0,this.initiative.round<0&&(this.initiative.round=0),this.sendTurn()},sendTurn:function(){var e={turn:this.initiative.turn,round:this.initiative.round};socket.emit("initiative:setTurn",e)}},events:{"evt-setTurn":function(e){this.setTurn(e)}}});Vue.component("ap-initiative-gm",ApInitiativeGm);var ApInitiativePlayer=Vue.extend({template:'<div class="row"><div class="small-6 columns"><strong><span style="color: #c5c5c5;">Turn</span> {{ initiative.turn+1 }}</strong></div><div class="small-6 columns text-right"><strong><span style="color: #c5c5c5;">Round</span> {{ initiative.round+1 }}</strong></div></div><ul class="no-bullet"><li v-for="(index, entity) in initiative.entities | orderBy \'initiative\' -1"><ap-initiative-badge-player v-bind:entity="entity" v-bind:isgm="isgm" v-bind:index="index" v-bind:turn="initiative.turn"></ap-initiative-badge></li></ul>',components:{"ap-initiative-badge-player":ApInitiativeBadgePlayer},props:["initiative"]});Vue.component("ap-initiative-player",ApInitiativePlayer);var ApOnlineUsers=Vue.extend({template:'<ul class="no-bullet"><li v-for="user in users" transition="staggered" stagger="300"><a v-on:click="privateMessage(user.name)"><i class="fa fa-paper-plane"></i> {{ user.name }}</a></li></ul>',props:["users"],methods:{privateMessage:function(e){this.$dispatch("evt-privateMessage",e)}}});Vue.component("ap-online-users",ApOnlineUsers);var ApCore=new Vue({el:"#ap-core",data:ApStore,components:{"ap-chat-input":ApChatInput,"ap-chat-messages":ApChatMessages,"ap-dice-bag":ApDiceBag,"ap-initiative-gm":ApInitiativeGm,"ap-initiative-player":ApInitiativePlayer,"ap-online-users":ApOnlineUsers},ready:function(){ApStore.token=token},methods:{setUser:function(e){ApStore.user.name=e.name,ApStore.user.color=e.color,ApStore.user.residentId=e.residentId,ApStore.user.characterId=e.characterId,ApStore.user.campaignId=e.campaignId},addMessage:function(e){if(e.timestamp&&(this.lastTimestamp=e.timestamp),e.timestamp=e.timestamp||(new Date).getTime(),e.cssClass="ap-msg-"+e.type,"private"===e.type)switch(console.log(e.sender),e.sender){case this.user.name:e.cssClass+="-me";break;case"GM":e.cssClass+="-gm";break;default:e.cssClass+="-player"}e.usercolor=e.sender===this.user.name?"#000":e.usercolor,e.showReply=e.sender!==this.user.name,this.messages.unshift(e),this.messages.length>50&&this.messages.pop()},addBuff3r:function(e){for(i in e){if(e[i].cssClass="ap-msg-"+e[i].type,"private"===e[i].type)switch(e[i].sender){case this.user.name:e[i].cssClass+="-me";break;case"GM":e[i].cssClass+="-gm";break;default:e[i].cssClass+="-player"}e[i].usercolor=e[i].sender===this.user.name?"#000":e[i].usercolor,e[i].showReply=e[i].sender!==this.user.name,this.messages.unshift(e[i]),this.messages.length>50&&this.messages.pop()}},loadInitiative:function(e){this.initiative=e},privateMessage:function(e){this.inputText='/w "'+e+'" ',$("#ap-panel-chat-link").click(),$("#ap-inputText").focus()},toggleActiveUsers:function(){$(".eb-v1-badge-gm").removeClass("active"),$(".eb-v1-badge-Character").removeClass("active");for(user in this.users)"GM"===this.users[user].name?$("#badge_gm_"+this.users[user].residentId).addClass("active"):$("#badge_"+this.users[user].characterId).addClass("active")},sendLogin:function(){socket.emit("login",this.token,this.lastTimestamp)},sendMessage:function(e){e.type=e.recipient?"private":"public",e.sender=this.user.name,socket.emit("message",e)},sendDice:function(e){e.type="dice",socket.emit("dice",e),$("#ap-panel-chat-link").click()},sendEntities:function(){var e={entities:this.initiative.entities};socket.emit("initiative:setEntities",e)},addEntity:function(e){$("#ap-panel-initiative-link").click(),this.initiative.entities.push(e),this.sendEntities()},setTurn:function(e){this.initiative.timestamp=e.timestamp,this.initiative.turn=e.turn,this.initiative.round=e.round},setEntities:function(e){this.initiative.timestamp=e.timestamp,this.initiative.entities=e.entities},removeEntity:function(e){this.initiative.entities.$remove(e),this.sendEntities()}},events:{"evt-addMessage":function(e){this.addMessage(e)},"evt-addEntity":function(e){this.addEntity(e)},"evt-privateMessage":function(e){this.privateMessage(e)},"evt-sendMessage":function(e){this.sendMessage(e)},"evt-sendDice":function(e){this.sendDice(e)},"evt-removeEntity":function(e){this.removeEntity(e)},"evt-sendEntities":function(){this.sendEntities()},"evt-toggleActiveUsers":function(){this.toggleActiveUsers()}}}),socket=io(ap_sok);socket.on("connect",function(){ApCore.sendLogin(),$("[data-timestamp]").each(function(){var e=new moment(new Date($(this).data("timestamp")));$(this).text(e.calendar(null,{sameElse:"MMM Do YYYY"}))})}),socket.on("welcome",function(e){$(".ap-v1-status-gear i").removeClass("fa-ban fa-gear fa-spin"),$(".ap-v1-status-gear i").addClass("fa-comments"),ApCore.setUser(e),socket.emit("onlineUsers")}),socket.on("userJoined",function(e){socket.emit("onlineUsers")}),socket.on("userLeft",function(e){socket.emit("onlineUsers")}),socket.on("onlineUsers",function(e){ApStore.users=e,ApCore.$emit("evt-toggleActiveUsers")}),socket.on("message",function(e){ApCore.addMessage(e)}),socket.on("buff3r",function(e){ApCore.addBuff3r(e)}),socket.on("loadInitiative",function(e){e.turn=parseInt(e.turn,10)||0,e.round=parseInt(e.round,10)||0,e.entities=JSON.parse(e.entities),ApCore.loadInitiative(e)}),socket.on("initiative:setTurn",function(e){ApCore.setTurn(e)}),socket.on("initiative:setEntities",function(e){ApCore.setEntities(e)}),socket.on("disconnect",function(e){$(".ap-v1-status-gear i").removeClass("fa-ban"),$(".ap-v1-status-gear i").removeClass("fa-comments"),$(".ap-v1-status-gear i").addClass("fa-gear fa-spin")}),socket.on("expired",function(){$(".ap-v1-status-gear i").removeClass("fa-comments"),$(".ap-v1-status-gear i").removeClass("fa-gear fa-spin"),$(".ap-v1-status-gear i").addClass("fa-ban"),new_token(campaign)});